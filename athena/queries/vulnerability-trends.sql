-- ========================================
-- Vulnerability Trend Analysis
-- ========================================
-- Shows daily vulnerability counts by severity
-- Useful for tracking if security is improving or degrading
-- ========================================

-- Daily vulnerability count by severity (last 30 days)
SELECT 
  CONCAT(year, '-', month, '-', day) as scan_date,
  vuln.Severity,
  COUNT(*) as vulnerability_count
FROM security_analytics.trivy_scans
CROSS JOIN UNNEST(Results) AS t(result)
CROSS JOIN UNNEST(result.Vulnerabilities) AS v(vuln)
WHERE 
  CAST(CONCAT(year, month, day) AS INTEGER) >= CAST(date_format(current_date - interval '30' day, '%Y%m%d') AS INTEGER)
GROUP BY year, month, day, vuln.Severity
ORDER BY scan_date DESC, vuln.Severity;


-- Total vulnerabilities per day (simplified view)
SELECT 
  CONCAT(year, '-', month, '-', day) as scan_date,
  COUNT(*) as total_vulnerabilities,
  SUM(CASE WHEN vuln.Severity = 'CRITICAL' THEN 1 ELSE 0 END) as critical_count,
  SUM(CASE WHEN vuln.Severity = 'HIGH' THEN 1 ELSE 0 END) as high_count,
  SUM(CASE WHEN vuln.Severity = 'MEDIUM' THEN 1 ELSE 0 END) as medium_count,
  SUM(CASE WHEN vuln.Severity = 'LOW' THEN 1 ELSE 0 END) as low_count
FROM security_analytics.trivy_scans
CROSS JOIN UNNEST(Results) AS t(result)
CROSS JOIN UNNEST(result.Vulnerabilities) AS v(vuln)
WHERE 
  CAST(CONCAT(year, month, day) AS INTEGER) >= CAST(date_format(current_date - interval '30' day, '%Y%m%d') AS INTEGER)
GROUP BY year, month, day
ORDER BY scan_date DESC;

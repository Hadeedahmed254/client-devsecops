name: Infrastructure Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - destroy

jobs:
  manage-infrastructure:
    name: ${{ github.event.inputs.action == 'deploy' && 'Deploy' || 'Destroy' }} Infrastructure
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    # ========================================
    # DEPLOY ACTION
    # ========================================
    
    - name: Prepare Terraform Environment
      run: |
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        STATE_BUCKET="terraform-state-${ACCOUNT_ID}"
        
        # Ensure State Bucket Exists
        if ! aws s3 ls "s3://${STATE_BUCKET}" 2>&1 | grep -q 'NoSuchBucket'; then
          echo "‚úÖ Using existing state bucket: ${STATE_BUCKET}"
        else
          echo "üì¶ Creating state bucket: ${STATE_BUCKET}"
          aws s3 mb "s3://${STATE_BUCKET}" --region ${{ vars.AWS_REGION || 'us-east-1' }}
          aws s3api put-bucket-versioning --bucket "${STATE_BUCKET}" --versioning-configuration Status=Enabled
        fi

        # Write Backend Config
        cat > terraform/security-reports-s3/backend.tf <<EOF
        terraform {
          backend "s3" {
            bucket  = "${STATE_BUCKET}"
            key     = "security-reports-s3/terraform.tfstate"
            region  = "${{ vars.AWS_REGION || 'us-east-1' }}"
            encrypt = true
          }
        }
        EOF
        echo "‚úÖ Backend configured."

    - name: Terraform Init
      run: terraform init -reconfigure
      working-directory: terraform/security-reports-s3
    
    - name: Terraform Plan
      if: github.event.inputs.action == 'deploy'
      run: terraform plan -out=tfplan
      working-directory: terraform/security-reports-s3
    
    - name: Terraform Apply
      if: github.event.inputs.action == 'deploy'
      run: terraform apply -auto-approve tfplan
      working-directory: terraform/security-reports-s3
    
    - name: Save Terraform Outputs
      if: github.event.inputs.action == 'deploy'
      id: tf-outputs
      run: |
        echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
        echo "role_arn=$(terraform output -raw github_actions_role_arn)" >> $GITHUB_OUTPUT
        echo "region=$(terraform output -raw aws_region)" >> $GITHUB_OUTPUT
      working-directory: terraform/security-reports-s3
    
    - name: Display Setup Instructions
      if: github.event.inputs.action == 'deploy'
      run: |
        echo "========================================="
        echo "‚úÖ INFRASTRUCTURE DEPLOYED SUCCESSFULLY!"
        echo "========================================="
        echo ""
        echo "üìã Add these to GitHub Variables:"
        echo ""
        echo "AWS_REGION: ${{ steps.tf-outputs.outputs.region }}"
        echo "AWS_ROLE_ARN: ${{ steps.tf-outputs.outputs.role_arn }}"
        echo "S3_SECURITY_REPORTS_BUCKET: ${{ steps.tf-outputs.outputs.s3_bucket }}"
        echo ""
        echo "========================================="
        echo "Next Steps:"
        echo "1. Add the variables above to GitHub"
        echo "2. Setup Athena database (run athena/setup.sql)"
        echo "3. Run CICD Pipeline"
        echo "========================================="
    
    # ========================================
    # DESTROY ACTION
    # ========================================
    
    # Destruction Logic
    
    - name: Empty S3 Buckets Before Destroy
      if: github.event.inputs.action == 'destroy'
      run: |
        echo "üóëÔ∏è Emptying S3 buckets before destruction..."
        
        # Get bucket name safely
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        BUCKET_NAME="bankapp-security-reports-${ACCOUNT_ID}"
        
        echo "Targeting bucket: ${BUCKET_NAME}"
        
        # Check if bucket exists
        if aws s3 ls "s3://${BUCKET_NAME}" 2>&1 | grep -q 'NoSuchBucket'; then
          echo "‚ö†Ô∏è Bucket ${BUCKET_NAME} not found or already deleted. Skipping."
        else
          echo "üöÄ Cleaning all versions and markers from ${BUCKET_NAME}..."
          
          # Remove all objects (standard)
          aws s3 rm "s3://${BUCKET_NAME}" --recursive || true
          
          # Remove all versions and delete markers (required for versioned buckets)
          # We use a loop to handle large buckets
          while :; do
            VERSIONS=$(aws s3api list-object-versions \
              --bucket "${BUCKET_NAME}" \
              --max-items 1000 \
              --output json --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}, DeleteMarkers: DeleteMarkers[].{Key:Key,VersionId:VersionId}}')
            
            # Check if we have anything to delete
            V_COUNT=$(echo $VERSIONS | jq '.Objects | length // 0')
            D_COUNT=$(echo $VERSIONS | jq '.DeleteMarkers | length // 0')
            
            if [ "$V_COUNT" -eq "0" ] && [ "$D_COUNT" -eq "0" ]; then
              break
            fi
            
            echo "Deleting $V_COUNT versions and $D_COUNT delete markers..."
            
            if [ "$V_COUNT" -gt "0" ]; then
              echo $VERSIONS | jq -c '{Objects: .Objects, Quiet: true}' > marker.json
              aws s3api delete-objects --bucket "${BUCKET_NAME}" --delete file://marker.json || true
            fi
            
            if [ "$D_COUNT" -gt "0" ]; then
              echo $VERSIONS | jq -c '{Objects: .DeleteMarkers, Quiet: true}' > markers.json
              aws s3api delete-objects --bucket "${BUCKET_NAME}" --delete file://markers.json || true
            fi
          done
          
          echo "‚úÖ ${BUCKET_NAME} is now empty."
        fi
      working-directory: terraform/security-reports-s3
      continue-on-error: true
    
    - name: Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      run: terraform destroy -auto-approve
      working-directory: terraform/security-reports-s3
    
    - name: Delete Terraform State Bucket
      if: github.event.inputs.action == 'destroy'
      run: |
        echo "üóëÔ∏è Deleting Terraform state bucket..."
        
        # Empty state bucket
        aws s3 rm "s3://${STATE_BUCKET}" --recursive || true
        
        # Delete all versions
        aws s3api delete-objects \
          --bucket "${STATE_BUCKET}" \
          --delete "$(aws s3api list-object-versions \
            --bucket "${STATE_BUCKET}" \
            --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}' \
            --max-items 1000)" 2>/dev/null || true
        
        # Delete bucket
        aws s3 rb "s3://${STATE_BUCKET}" --force || true
        
        echo "‚úÖ State bucket deleted: ${STATE_BUCKET}"
    
    - name: Cleanup Complete
      if: github.event.inputs.action == 'destroy'
      run: |
        echo "========================================="
        echo "‚úÖ INFRASTRUCTURE DESTROYED SUCCESSFULLY!"
        echo "========================================="
        echo ""
        echo "üóëÔ∏è Deleted:"
        echo "  - S3 security reports bucket"
        echo "  - IAM roles and policies"
        echo "  - Terraform state bucket"
        echo ""
        echo "üìã Next Steps:"
        echo "  - Remove GitHub variables:"
        echo "    ‚Ä¢ AWS_REGION"
        echo "    ‚Ä¢ AWS_ROLE_ARN"
        echo "    ‚Ä¢ S3_SECURITY_REPORTS_BUCKET"
        echo ""
        echo "========================================="

name: EKS Provisioning

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
        - apply
        - destroy

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./eks-terraform

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Terraform Init
      run: terraform init

    - name: Terraform Validate
      run: terraform validate

    - name: Terraform Plan
      run: terraform plan

    - name: Terraform Action
      run: terraform ${{ github.event.inputs.action }} -auto-approve

  setup-argocd:
    name: Install ArgoCD
    needs: terraform
    if: github.event.inputs.action == 'apply'
    runs-on: ubuntu-latest
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Update Kubeconfig
      run: aws eks update-kubeconfig --name project-eks --region us-east-1

    - name: Install ArgoCD
      run: |
        kubectl create namespace argocd || true
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    - name: Expose ArgoCD Server
      run: |
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

    - name: Get ArgoCD Admin Password
      run: |
        echo "Initial Admin Password:"
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
        echo ""

    - name: Get ArgoCD External URL
      run: |
        echo "Waiting for LoadBalancer to generate DNS..."
        sleep 30
        kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
        echo ""

  setup-monitoring:
    name: Install Monitoring Stack
    needs: setup-argocd
    if: github.event.inputs.action == 'apply'
    runs-on: ubuntu-latest
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Update Kubeconfig
      run: aws eks update-kubeconfig --name project-eks --region us-east-1

    - name: Install Helm
      uses: azure/setup-helm@v4

    - name: Install Prometheus & Grafana
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        kubectl create namespace monitoring || true
        
        # Install with Grafana and Prometheus services both as LoadBalancers
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --set grafana.service.type=LoadBalancer \
          --set grafana.service.port=9000 \
          --set grafana.service.targetPort=3000 \
          --set prometheus.service.type=LoadBalancer \
          --set prometheus.service.port=9090

    - name: Get Grafana Admin Password
      run: |
        echo "Grafana Admin User: admin"
        echo "Grafana Admin Password:"
        kubectl get secret -n monitoring prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 --decode
        echo ""

    - name: Get Monitoring URLs
      run: |
        echo "Waiting for LoadBalancers to generate DNS..."
        sleep 60
        echo "------------------------------------------------"
        echo "Grafana Portal (Port 9000):"
        kubectl get svc -n monitoring prometheus-grafana -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
        echo ":9000"
        echo ""
        echo "Prometheus Portal (Port 9090):"
        kubectl get svc -n monitoring prometheus-kube-prometheus-prometheus -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
        echo ":9090"
        echo "------------------------------------------------"

name: Generate Demo Data

on:
  workflow_dispatch:

jobs:
  generate-demo-data:
    name: Generate 30 Days of Demo Data
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install Dependencies
      run: pip install boto3
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
    
    - name: Generate Test Data
      run: python scripts/generate_test_data.py
      env:
        S3_SECURITY_REPORTS_BUCKET: ${{ vars.S3_SECURITY_REPORTS_BUCKET }}
    
    - name: Repair Athena Partitions
      run: |
        echo "üîß Repairing Athena partitions..."
        
        # Repair trivy_scans partitions
        aws athena start-query-execution \
          --query-string "MSCK REPAIR TABLE security_analytics.trivy_scans;" \
          --result-configuration "OutputLocation=s3://${{ vars.S3_SECURITY_REPORTS_BUCKET }}/athena-results/" \
          --query-execution-context "Database=security_analytics" \
          --region ${{ vars.AWS_REGION || 'us-east-1' }}
        
        sleep 5
        
        # Repair gitleaks_scans partitions
        aws athena start-query-execution \
          --query-string "MSCK REPAIR TABLE security_analytics.gitleaks_scans;" \
          --result-configuration "OutputLocation=s3://${{ vars.S3_SECURITY_REPORTS_BUCKET }}/athena-results/" \
          --query-execution-context "Database=security_analytics" \
          --region ${{ vars.AWS_REGION || 'us-east-1' }}
        
        sleep 5
        
        # Repair scan_metadata partitions
        aws athena start-query-execution \
          --query-string "MSCK REPAIR TABLE security_analytics.scan_metadata;" \
          --result-configuration "OutputLocation=s3://${{ vars.S3_SECURITY_REPORTS_BUCKET }}/athena-results/" \
          --query-execution-context "Database=security_analytics" \
          --region ${{ vars.AWS_REGION || 'us-east-1' }}
        
        echo "‚úÖ Partitions repaired"
    
    - name: Verify Data
      run: |
        echo "üîç Verifying demo data..."
        
        # Check if tables exist first
        if ! aws athena start-query-execution \
          --query-string "SHOW TABLES IN security_analytics" \
          --result-configuration "OutputLocation=s3://${{ vars.S3_SECURITY_REPORTS_BUCKET }}/athena-results/" \
          --query-execution-context "Database=security_analytics" \
          --region ${{ vars.AWS_REGION || 'us-east-1' }} 2>/dev/null; then
          echo "‚ö†Ô∏è Athena tables not created yet. Run 'Athena Database Management ‚Üí setup' first."
          echo "üì¶ Data has been uploaded to S3 successfully."
          exit 0
        fi
        
        echo "Running verification query..."
        QUERY_ID=$(aws athena start-query-execution \
          --query-string "SELECT COUNT(*) as total_scans FROM security_analytics.trivy_scans;" \
          --result-configuration "OutputLocation=s3://${{ vars.S3_SECURITY_REPORTS_BUCKET }}/athena-results/" \
          --query-execution-context "Database=security_analytics" \
          --region ${{ vars.AWS_REGION || 'us-east-1' }} \
          --query 'QueryExecutionId' \
          --output text)
        
        # Wait for query to complete
        for i in {1..30}; do
          STATE=$(aws athena get-query-execution \
            --query-execution-id $QUERY_ID \
            --region ${{ vars.AWS_REGION || 'us-east-1' }} \
            --query 'QueryExecution.Status.State' \
            --output text)
          
          if [ "$STATE" = "SUCCEEDED" ]; then
            break
          elif [ "$STATE" = "FAILED" ] || [ "$STATE" = "CANCELLED" ]; then
            echo "‚ö†Ô∏è Query failed. This is normal if tables haven't been created yet."
            echo "üì¶ Data uploaded successfully. Run 'Athena Database Management ‚Üí setup' to create tables."
            exit 0
          fi
          
          sleep 2
        done
        
        # Get results if query succeeded
        if [ "$STATE" = "SUCCEEDED" ]; then
          RESULT=$(aws athena get-query-results \
            --query-execution-id $QUERY_ID \
            --region ${{ vars.AWS_REGION || 'us-east-1' }} \
            --query 'ResultSet.Rows[1].Data[0].VarCharValue' \
            --output text)
          
          echo "üìä Total scans in Athena: $RESULT"
          
          if [ "$RESULT" = "30" ]; then
            echo "‚úÖ Demo data verified: 30 days of data created!"
          else
            echo "‚ö†Ô∏è Expected 30 scans, found $RESULT"
          fi
        else
          echo "üì¶ Data uploaded to S3. Verification will work after Athena setup."
        fi
      continue-on-error: true
    
    - name: Display Summary
      run: |
        echo "========================================="
        echo "‚úÖ DEMO DATA GENERATION COMPLETE!"
        echo "========================================="
        echo ""
        echo "üìä Created: 30 days of historical security reports"
        echo "üìÖ Date range: $(date -d '30 days ago' +%Y-%m-%d) to $(date -d 'yesterday' +%Y-%m-%d)"
        echo ""
        echo "üìã Data includes:"
        echo "  ‚Ä¢ Trivy vulnerability scans"
        echo "  ‚Ä¢ Gitleaks secret scans"
        echo "  ‚Ä¢ Scan metadata"
        echo ""
        echo "üîó S3 Location: s3://${{ vars.S3_SECURITY_REPORTS_BUCKET }}/"
        echo ""
        echo "========================================="
        echo "Next Steps:"
        echo "1. Run CICD pipeline for today's real scan"
        echo "2. Query data in AWS Athena console"
        echo "3. Setup QuickSight dashboards"
        echo "4. Demo to client!"
        echo "========================================="
